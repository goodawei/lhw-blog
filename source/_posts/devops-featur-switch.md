---
title: Best practice for feature switch of devops  
date: 2017-05-14 21:55:47
tags: devops
categories: devops
---


### 为什么要使用特性开关?

- 上线周期短，屏蔽在单一上线周期内已开发但未完成的特性（例如每周两次上线，但“产品列表”功能需要三周才能开发完成）
- 对比在不同 UI 下的用户行为和转化率（A/B Testing）
- 部署与发布分离，持续频繁部署，业务随时可发布
- 部署：代码部署到生产环境
- 发布：特性上线，交付给最终用户使用,部署与发布分离，开发团队频繁持续进行部署，而业务人员（需求方）决定特性何时发布。

----

<!-- more -->

### 为什么不继续使用旧做法（挑代码）？

旧做法：每次发布前，从代码仓库中，由开发组长从最近的若干提交中，手工挑选出需要上线的若干个提交，测试人员进行测试并发布。
这种做法：

- 生产环境和开发主干代码不一致，违背了单一主干代码的策略，造成代码库版本碎片化
- 与持续集成理念背道而驰（不能早期集成、早期测试、提供快速反馈）

---

### 为什么不用 Git Branch？

Long-lived feature branch是一个常见的持续交付反模式。这是因为：如果项目拥有多个长期彼此独立演进的分支，往往需要等到最后发布时才合并代码，这与持续集成的最佳实践背道而驰。
可参见 ThoughtWorks技术雷达相关介绍：https://www.thoughtworks.com/radar/techniques/long-lived-branches-with-gitflow

----

### 特性开关是解决问题的最后手段

为了隐藏未完成的特性进入生产环境，我们应遵循以下步骤：

- 首先考虑将大的业务特性分解，分批次小步引入新的特性。这样做的好处是减少上线风险，并收集用户对于新特性的真实使用反馈，便于持续改进该特性。
- 其次，可以考虑新特性UI的入口地址与已有UI分离，给新特性赋予一个全新的URL，但不暴露该地址给真实用户，即可隐藏未完成的特性。最后才考虑特性开关，作为解决问题的最后手段。


---

### 使用特性开关的注意事项

- 使用特性开关包裹某一特性时，要特别注意不要遗漏某些特性代码在开关范围之外。
- 使用了特性开关后，测试人员的测试策略 - 通常说来只需测试下列两种情况：
1. 启用所有下一次上线发布时需要的功能的情况
2. 启用所有功能的情况
- 由特性开关控制的功能正式上线并稳定后，务必要去掉特性开关代码，包括配置文件中特性开关变量以及所有使用特性开关的代码。
- 特性开关数量不能太多，一旦超过限定数量，务必清理已有特性开关
